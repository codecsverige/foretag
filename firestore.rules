rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ----------------------------
    // Shared helpers
    // ----------------------------
    function isBusCompanyOrAdmin() {
      return isSignedIn() && (
        // Require user document with userType of 'bus_company' or 'admin'
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType in ['bus_company', 'admin']
      );
    }

    // Bus routes: public read; write restricted to bus companies/admins
    match /busRoutes/{routeId} {
      allow read: if true;

      allow create: if isBusCompanyOrAdmin()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.keys().hasAll([
          'company','from','to','price','currency','totalSeats','availableSeats',
          'amenities','bookingUrl','busNumber','status','type','createdBy',
          'departureAt','arrivalAt'
        ]);

      allow update: if isBusCompanyOrAdmin()
        && resource.data.createdBy == request.auth.uid
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'company','from','to','price','currency','totalSeats','availableSeats',
          'amenities','bookingUrl','busNumber','status','updatedAt','departureAt','arrivalAt','duration'
        ]);

      allow delete: if isBusCompanyOrAdmin() && resource.data.createdBy == request.auth.uid;
    }

    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasOnly([
          'email','phone','role','balance','createdAt','displayName','userId'
        ]);
      allow delete: if false;
    }

    // =========================================================
    // BokaNÃ¤ra (new product): businesses + services + appointments
    // =========================================================
    // Memberships are stored as: businessMemberships/{businessId}_{uid}
    function membershipId(businessId) {
      return businessId + '_' + request.auth.uid;
    }
    function isBusinessMember(businessId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/businessMemberships/$(membershipId(businessId)));
    }
    function isBusinessOwner(businessId) {
      return isBusinessMember(businessId)
        && get(/databases/$(database)/documents/businessMemberships/$(membershipId(businessId))).data.role == 'owner';
    }
    function isBusinessStaff(businessId) {
      return isBusinessMember(businessId)
        && get(/databases/$(database)/documents/businessMemberships/$(membershipId(businessId))).data.role in ['owner','admin','staff'];
    }

    // Public business profile (read); write restricted to owner/admin
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.keys().hasAll(['name','city','ownerUid','createdAt']);
      allow update: if isBusinessOwner(businessId)
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;
    }

    // Membership document: businessMemberships/{businessId}_{uid}
    match /businessMemberships/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.uid;
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.keys().hasAll(['businessId','uid','role','createdAt'])
        && (request.resource.data.role in ['owner','admin','staff']);
      // Only business owner can manage staff roles (except their own owner role)
      allow update: if isSignedIn()
        && (
          // user can update their own "lastSeenAt" style fields (future-safe)
          (request.auth.uid == resource.data.uid)
          ||
          // owner can update other membership roles
          (isBusinessOwner(resource.data.businessId) && request.resource.data.uid == resource.data.uid)
        )
        && request.resource.data.businessId == resource.data.businessId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false;
    }

    // Services: public read; write restricted to business staff
    match /services/{serviceId} {
      allow read: if true;
      allow create: if isSignedIn()
        && isBusinessStaff(request.resource.data.businessId)
        && request.resource.data.keys().hasAll(['businessId','name','durationMin','price','currency','createdAt']);
      allow update: if isSignedIn()
        && isBusinessStaff(resource.data.businessId)
        && request.resource.data.businessId == resource.data.businessId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn() && isBusinessOwner(resource.data.businessId);
    }

    // Appointments (Bookings): private read for parties (customer or business staff)
    match /appointments/{appointmentId} {
      function isParty() {
        return isSignedIn() && (
          request.auth.uid == resource.data.userId ||
          isBusinessStaff(resource.data.businessId)
        );
      }
      allow read: if isParty();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll([
          'businessId','serviceId','userId','status','startAt','endAt','createdAt'
        ]);
      allow update: if isParty()
        && request.resource.data.businessId == resource.data.businessId
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.serviceId == resource.data.serviceId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'status','notes','customerNote','staffNote','updatedAt','cancelledAt'
        ]);
      allow delete: if false;
    }

    // Reminders: created/managed by server; readable by parties only
    match /reminders/{reminderId} {
      allow read: if isSignedIn()
        && (
          request.auth.uid == resource.data.userId ||
          isBusinessStaff(resource.data.businessId)
        );
      allow create, update, delete: if false;
    }

    match /rides/{rideId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.createdAt is string;
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.userId
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /bookings/{bookingId} {
      function isParty() {
        return isSignedIn() && (
          request.auth.uid == resource.data.userId ||
          request.auth.uid == resource.data.counterpartyId
        );
      }
      allow read: if isParty();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll([
          'bookingType','rideId','userId','counterpartyId','status','createdAt'
        ]);
      allow update: if isParty()
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.counterpartyId == resource.data.counterpartyId
        && request.resource.data.rideId == resource.data.rideId
        && request.resource.data.bookingType == resource.data.bookingType
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'status','paidAt','contactUnlockedAt','driverEmailShared','driverPhoneShared','cancelledAt','seats','price'
        ]);
      allow delete: if isParty() && !(resource.data.status in ['captured','paid']);
    }

    // alerts: each user can create and read own alerts; no mass delete
    match /alerts/{alertId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    match /notifications/{id} {
      allow read: if isSignedIn() && request.auth.token.email == resource.data.userEmail;
      allow create: if isSignedIn()
        && request.resource.data.userEmail == request.auth.token.email
        && request.resource.data.keys().hasAll(['userEmail','userName','title','body','type','createdAt','read','sent']);
      allow update, delete: if false;
    }

    match /contact_unlock/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.counterpartyId
      );
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['rideId','userId','counterpartyId','paidAt','createdAt']);
      allow update: if isSignedIn()
        && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.counterpartyId)
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.counterpartyId == resource.data.counterpartyId
        && request.resource.data.rideId == resource.data.rideId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['paidAt']);
      allow delete: if false;
    }

    match /{document=**} { allow read, write: if false; }
  }
}

