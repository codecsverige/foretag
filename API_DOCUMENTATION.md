# V√§gV√§nner - API & Database Documentation
## ÿ™Ÿàÿ´ŸäŸÇ API ŸàŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

**Version:** 1.0  
**Last Updated:** 2025-10-07  
**For:** Developers & New Owners

---

## üìã Table of Contents

1. [Firestore Database Structure](#firestore-database-structure)
2. [Firestore Security Rules](#firestore-security-rules)
3. [Firebase Cloud Functions](#firebase-cloud-functions)
4. [External APIs](#external-apis)
5. [Data Flow Diagrams](#data-flow-diagrams)
6. [Common Queries](#common-queries)
7. [Indexes Required](#indexes-required)

---

## 1. Firestore Database Structure | ŸáŸäŸÉŸÑ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

### Overview | ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©

V√§gV√§nner uses **Firebase Firestore** (NoSQL document database) with the following collections:

```
firestore
‚îú‚îÄ‚îÄ users/              (User profiles)
‚îú‚îÄ‚îÄ rides/              (Ride listings - offers & requests)
‚îú‚îÄ‚îÄ bookings/           (Booking requests)
‚îú‚îÄ‚îÄ contact_unlock/     (Paid contact unlocks)
‚îú‚îÄ‚îÄ alerts/             (Search alerts for users)
‚îú‚îÄ‚îÄ notifications/      (In-app notifications)
‚îî‚îÄ‚îÄ busRoutes/          (Bus route listings - optional feature)
```

---

### Collection: `users`

**Purpose:** Store user profile information  
**Access:** User can read/write own document only  
**Created When:** User signs in for the first time

#### Document Structure

```javascript
{
  // Document ID = Firebase Auth UID
  
  // Basic Info
  userId: string,              // Same as document ID (Firebase UID)
  email: string,               // User's email (from Google OAuth)
  displayName: string,         // User's full name
  photoURL: string,            // Profile picture URL (from Google)
  
  // Contact Info
  phoneNumber: string,         // Verified phone in E.164 format
                              // Example: "+46701234567"
  
  // Metadata
  createdAt: string,          // ISO 8601 timestamp
                              // Example: "2025-01-15T10:30:00.000Z"
  
  // Optional Fields
  role: string,               // "f√∂rare" | "passagerare" (informational only)
  balance: number,            // Future feature - not used yet
  userType: string            // "bus_company" | "admin" (for special users)
}
```

#### Example Document

```javascript
// Document ID: "abc123xyz789"
{
  userId: "abc123xyz789",
  email: "johan.andersson@gmail.com",
  displayName: "Johan Andersson",
  photoURL: "https://lh3.googleusercontent.com/...",
  phoneNumber: "+46701234567",
  createdAt: "2025-01-15T10:30:00.000Z",
  role: "f√∂rare"
}
```

#### Queries Used

```javascript
// Get user profile
const userDoc = await getDoc(doc(db, "users", userId));

// Create/Update user
await setDoc(doc(db, "users", userId), {
  userId,
  email,
  displayName,
  photoURL,
  phoneNumber,
  createdAt: new Date().toISOString()
}, { merge: true });
```

---

### Collection: `rides`

**Purpose:** Store ride listings (both offers and requests)  
**Access:** Public read, owner write  
**Created When:** User creates a ride via /create-ride

#### Document Structure

```javascript
{
  // Document ID = Auto-generated by Firestore
  
  // Owner Info
  userId: string,              // Owner's Firebase UID
  driverName: string,          // Owner's display name
  driverEmail: string,         // Owner's email
  driverPhone: string,         // Owner's phone (verified)
  
  // Ride Type
  role: string,                // "f√∂rare" (driver) | "passagerare" (passenger)
  type: string,                // "offer" | "request"
                              // offer = driver offering ride
                              // request = passenger requesting ride
  
  // Trip Details
  origin: string,              // Full address or city
                              // Example: "Stockholm, Sweden"
  destination: string,         // Full address or city
                              // Example: "G√∂teborg, Sweden"
  date: string,                // ISO date (YYYY-MM-DD)
                              // Example: "2025-02-15"
  departureTime: string,       // 24h format (HH:MM)
                              // Example: "14:30"
  
  // Pricing
  price: number,               // Price in SEK
                              // 0 for "Flex" (cost sharing)
  costMode: string,            // "fixed_price" | "flexible"
  
  // Capacity (for drivers/offers)
  count: number,               // Total seats available
  seatsAvailable: number,      // Current available seats
                              // Decreases when bookings confirmed
  
  // Recurring Rides
  isRecurring: boolean,        // true if weekly recurring
  weekdays: string[],          // ["monday", "wednesday", "friday"]
                              // Only if isRecurring = true
  
  // Return Trip
  isReturn: boolean,           // true if round trip
  returnDate: string,          // ISO date (YYYY-MM-DD)
  returnTime: string,          // 24h format (HH:MM)
  
  // Preferences & Features
  passengerPreference: string, // "any" | "male" | "female" | "verified"
  genderPreference: string,    // Same as above
  conversationLevel: string,   // "quiet" | "moderate" | "chatty" | "flexible"
  smokingAllowed: boolean,
  petsAllowed: boolean,
  musicAllowed: boolean,
  foodAllowed: boolean,
  
  // Car Details (for drivers)
  carBrand: string,            // "Volvo", "Toyota", etc.
  carModel: string,            // "XC90", "Corolla", etc.
  carYear: number,             // 2020
  licensePlate: string,        // "ABC123"
  carColor: string,            // "Svart", "Vit", etc.
  carComfort: string,          // "basic" | "comfort" | "luxury"
  
  // Driver Info
  driverExperience: string,    // "beginner" | "experienced" | "professional"
  
  // Route Details
  routeFlexibility: string,    // "fixed" | "flexible" | "very_flexible"
  pickupFlexibility: string,   // "exact" | "flexible" | "very_flexible"
  
  // Additional Services
  specialServices: string[],   // ["wifi", "charger", "snacks", "child_seat"]
  
  // Trip Purpose
  tripType: string,            // "commute" | "leisure" | "urgent" | "other"
  tripPurpose: string,         // Free text description
  
  // Notes
  description: string,         // Additional notes/details
  
  // Status
  status: string,              // "active" | "completed" | "cancelled"
  archived: boolean,           // true if soft-deleted
  
  // Metadata
  createdAt: string,           // ISO 8601 timestamp
  updatedAt: string            // ISO 8601 timestamp
}
```

#### Example Document (Driver Offer)

```javascript
// Document ID: "ride_abc123"
{
  userId: "abc123xyz789",
  driverName: "Johan Andersson",
  driverEmail: "johan.andersson@gmail.com",
  driverPhone: "+46701234567",
  
  role: "f√∂rare",
  type: "offer",
  
  origin: "Stockholm, Sweden",
  destination: "G√∂teborg, Sweden",
  date: "2025-02-15",
  departureTime: "14:30",
  
  price: 200,
  costMode: "fixed_price",
  
  count: 3,
  seatsAvailable: 3,
  
  isRecurring: false,
  isReturn: true,
  returnDate: "2025-02-17",
  returnTime: "18:00",
  
  passengerPreference: "any",
  conversationLevel: "moderate",
  smokingAllowed: false,
  petsAllowed: true,
  
  carBrand: "Volvo",
  carModel: "XC90",
  carYear: 2020,
  licensePlate: "ABC123",
  carComfort: "comfort",
  
  driverExperience: "experienced",
  
  status: "active",
  archived: false,
  
  createdAt: "2025-01-15T10:30:00.000Z",
  updatedAt: "2025-01-15T10:30:00.000Z"
}
```

#### Queries Used

```javascript
// Get all active rides
const ridesQuery = query(
  collection(db, "rides"),
  where("archived", "==", false),
  where("status", "==", "active"),
  orderBy("createdAt", "desc"),
  limit(50)
);

// Search by city (requires index)
const searchQuery = query(
  collection(db, "rides"),
  where("origin", "==", "Stockholm, Sweden"),
  where("archived", "==", false)
);

// Get user's own rides
const userRidesQuery = query(
  collection(db, "rides"),
  where("userId", "==", userId),
  orderBy("createdAt", "desc")
);
```

---

### Collection: `bookings`

**Purpose:** Store booking requests from passengers to drivers  
**Access:** Both parties (userId and counterpartyId) can read/write  
**Created When:** Passenger books a ride

#### Document Structure

```javascript
{
  // Document ID = "seat_${rideId}_${userId}_${timestamp}"
  // Example: "seat_ride123_user456_1705318200000"
  
  // Type & IDs
  bookingType: string,         // "seat_booking" | "contact_unlock"
  rideId: string,              // Reference to rides collection
  userId: string,              // Passenger's UID
  counterpartyId: string,      // Driver's UID
  
  // Ride Snapshot (for reference)
  rideRole: string,            // Role of ride owner
  ride_origin: string,         // Trip origin
  ride_destination: string,    // Trip destination
  ride_date: string,           // Trip date
  ride_time: string,           // Departure time
  
  // Passenger Info
  passengerName: string,       // Passenger's name
  passengerEmail: string,      // Passenger's email (optional)
  passengerPhone: string,      // Passenger's phone (required)
  passengerComment: string,    // Message to driver
  
  // Driver Info
  driverName: string,          // Driver's name
  driverEmail: string,         // Driver's email
  driverPhone: string,         // Driver's phone
  
  // Booking Details
  seats: number,               // Number of seats requested (usually 1)
  price: number,               // Price per seat (from ride)
  commission: number,          // Platform commission (0 for initial booking)
                              // Updated to 10 after contact unlock
  
  // Status Flow:
  // requested ‚Üí authorized ‚Üí captured
  //         ‚Üò voided
  //         ‚Üò cancelled
  status: string,              // Current status
  
  // Timestamps (Unix timestamps in milliseconds)
  createdAt: number,           // When booking was created
  paidAt: number,              // When contact was unlocked (optional)
  contactUnlockedAt: number,   // When contact was revealed (optional)
  cancelledAt: number,         // When booking was cancelled (optional)
  
  // PayPal Info (added after unlock payment)
  paypal: {
    orderId: string,           // PayPal Order ID
    captureId: string,         // PayPal Capture ID (after 48h)
    status: string,            // "AUTHORIZED" | "CAPTURED" | "VOIDED"
    amount: number             // Amount in SEK (10)
  },
  
  // Contact Sharing Flags
  driverEmailShared: boolean,  // If driver's email was shared
  driverPhoneShared: boolean   // If driver's phone was shared
}
```

#### Status States

```javascript
// Status flow for bookings:

"requested"    // Initial state - passenger sent booking request
               // No payment yet
               
"authorized"   // Driver paid to unlock contact
               // PayPal authorization held (48h window)
               // Contact info revealed to driver
               
"captured"     // Payment captured after 48h
               // Money transferred to platform
               // Final state (successful)
               
"voided"       // Payment authorization voided
               // Money returned to user
               // User reported issue within 48h
               
"cancelled"    // Booking cancelled before payment
               // No money involved
               
"failed"       // Payment failed
               // Rare, usually network issues
```

#### Example Document

```javascript
// Document ID: "seat_ride123_user456_1705318200000"
{
  bookingType: "seat_booking",
  rideId: "ride123",
  userId: "user456",
  counterpartyId: "driver789",
  
  rideRole: "f√∂rare",
  ride_origin: "Stockholm, Sweden",
  ride_destination: "G√∂teborg, Sweden",
  ride_date: "2025-02-15",
  ride_time: "14:30",
  
  passengerName: "Anna Svensson",
  passengerEmail: "anna.svensson@gmail.com",
  passengerPhone: "+46709876543",
  passengerComment: "Har en liten resv√§ska, √§r det OK?",
  
  driverName: "Johan Andersson",
  driverEmail: "johan.andersson@gmail.com",
  driverPhone: "+46701234567",
  
  seats: 1,
  price: 200,
  commission: 0,  // Will be 10 after unlock
  
  status: "requested",
  
  createdAt: 1705318200000,
  // paidAt, contactUnlockedAt, cancelledAt will be added when applicable
}
```

#### After Contact Unlock

```javascript
// Same document after driver unlocks contact:
{
  // ... all previous fields ...
  
  commission: 10,
  status: "authorized",
  paidAt: 1705318260000,
  contactUnlockedAt: 1705318260000,
  
  paypal: {
    orderId: "7AB12345CD678901E",
    status: "AUTHORIZED",
    amount: 10
  },
  
  driverEmailShared: true,
  driverPhoneShared: true
}
```

#### After 48 Hours (Auto-Capture)

```javascript
// Same document after 48h auto-capture:
{
  // ... all previous fields ...
  
  status: "captured",
  
  paypal: {
    orderId: "7AB12345CD678901E",
    captureId: "9CD12345EF678901G",
    status: "CAPTURED",
    amount: 10
  }
}
```

#### Queries Used

```javascript
// Get driver's bookings (incoming requests)
const driverBookingsQuery = query(
  collection(db, "bookings"),
  where("counterpartyId", "==", driverId),
  orderBy("createdAt", "desc")
);

// Get passenger's bookings (outgoing requests)
const passengerBookingsQuery = query(
  collection(db, "bookings"),
  where("userId", "==", passengerId),
  orderBy("createdAt", "desc")
);

// Get bookings for specific ride
const rideBookingsQuery = query(
  collection(db, "bookings"),
  where("rideId", "==", rideId),
  orderBy("createdAt", "desc")
);
```

---

### Collection: `contact_unlock`

**Purpose:** Track who unlocked whose contact (for analytics)  
**Access:** Both parties can read  
**Created When:** User pays to unlock contact

#### Document Structure

```javascript
{
  // Document ID = Auto-generated
  
  rideId: string,              // Related ride
  userId: string,              // Who paid to unlock
  counterpartyId: string,      // Whose contact was unlocked
  
  paidAt: number,              // Unix timestamp
  createdAt: number,           // Unix timestamp
  
  // Flags for what was shared
  driverEmailShared: boolean,
  driverPhoneShared: boolean
}
```

#### Queries Used

```javascript
// Check if contact already unlocked
const unlockQuery = query(
  collection(db, "contact_unlock"),
  where("rideId", "==", rideId),
  where("userId", "==", userId),
  where("counterpartyId", "==", counterpartyId),
  limit(1)
);
```

---

### Collection: `alerts`

**Purpose:** Store search alerts for users (get notified of new rides)  
**Access:** User can read/write own alerts only  
**Created When:** User creates a search alert

#### Document Structure

```javascript
{
  // Document ID = Auto-generated
  
  userId: string,              // Owner's UID
  userEmail: string,           // For email notifications
  
  // Route
  originCity: string,          // Empty string for "all routes"
  destinationCity: string,     // Empty string for "all routes"
  scope: string,               // "route" | "global"
  
  // Status
  active: boolean,             // true = notifications enabled
  
  // Metadata
  createdAt: number            // Unix timestamp
}
```

#### Example Documents

```javascript
// Specific route alert
{
  userId: "user123",
  userEmail: "user@example.com",
  originCity: "Stockholm",
  destinationCity: "G√∂teborg",
  scope: "route",
  active: true,
  createdAt: 1705318200000
}

// Global alert (all new rides)
{
  userId: "user456",
  userEmail: "user2@example.com",
  originCity: "",
  destinationCity: "",
  scope: "global",
  active: true,
  createdAt: 1705318200000
}
```

#### Queries Used

```javascript
// Get user's alerts
const alertsQuery = query(
  collection(db, "alerts"),
  where("userId", "==", userId),
  where("active", "==", true)
);

// Find matching alerts for new ride
const matchingAlertsQuery = query(
  collection(db, "alerts"),
  where("originCity", "==", rideOriginCity),
  where("destinationCity", "==", rideDestinationCity),
  where("active", "==", true)
);
```

---

### Collection: `notifications`

**Purpose:** Store in-app notifications for users  
**Access:** User can read own notifications only  
**Created When:** System generates notification

#### Document Structure

```javascript
{
  // Document ID = Auto-generated
  
  userEmail: string,           // Recipient's email
  userName: string,            // Recipient's name
  
  title: string,               // Notification title
  body: string,                // Notification body (can be multiline)
  type: string,                // "success" | "info" | "warning" | "error"
  
  read: boolean,               // true if user has read
  sent: boolean,               // true if notification was delivered
  
  createdAt: number            // Unix timestamp
}
```

#### Example Document

```javascript
{
  userEmail: "johan.andersson@gmail.com",
  userName: "Johan",
  title: "Ny bokningsf√∂rfr√•gan! üì¨",
  body: "Du har f√•tt en ny bokningsf√∂rfr√•gan!\n\nüí∫ Antal platser: 1\n\nüìç F√∂r resan: Stockholm ‚Üí G√∂teborg\nüìÖ 2025-02-15 kl. 14:30\n\nLogga in p√• V√§gV√§nner f√∂r att hantera bokningen.",
  type: "info",
  read: false,
  sent: true,
  createdAt: 1705318200000
}
```

#### Queries Used

```javascript
// Get user's unread notifications
const notificationsQuery = query(
  collection(db, "notifications"),
  where("userEmail", "==", userEmail),
  where("read", "==", false),
  orderBy("createdAt", "desc"),
  limit(20)
);

// Mark as read
await updateDoc(doc(db, "notifications", notificationId), {
  read: true
});
```

---

### Collection: `busRoutes`

**Purpose:** Store bus company routes (optional feature)  
**Access:** Public read, bus_company/admin write  
**Created When:** Bus company creates a route

#### Document Structure

```javascript
{
  // Document ID = Auto-generated
  
  // Company Info
  company: string,             // Bus company name
  createdBy: string,           // Bus company user UID
  
  // Route
  from: string,                // Origin city
  to: string,                  // Destination city
  
  // Schedule
  departureAt: string,         // ISO 8601 timestamp
  arrivalAt: string,           // ISO 8601 timestamp
  duration: string,            // "3h 30min"
  
  // Pricing
  price: number,               // Price in SEK
  currency: string,            // "SEK"
  
  // Capacity
  totalSeats: number,          // Total seats on bus
  availableSeats: number,      // Current available seats
  
  // Features
  amenities: string[],         // ["wifi", "toilet", "ac", "usb"]
  
  // Booking
  bookingUrl: string,          // External booking URL
  busNumber: string,           // Bus identifier
  
  // Type
  type: string,                // "express" | "regional" | "local"
  
  // Status
  status: string,              // "active" | "cancelled"
  
  // Metadata
  createdAt: number,           // Unix timestamp
  updatedAt: number            // Unix timestamp
}
```

---

## 2. Firestore Security Rules | ŸÇŸàÿßÿπÿØ ÿßŸÑÿ£ŸÖÿßŸÜ

**File:** `firestore.rules`

### Key Security Principles

1. **Authentication Required:** Most operations require sign-in
2. **Ownership:** Users can only modify their own data
3. **Read Public:** Ride listings are public (for browsing)
4. **Write Private:** Only owner can create/edit their rides
5. **Booking Privacy:** Only involved parties can see bookings

### Rule Highlights

```javascript
// Users: Can only read/write own profile
match /users/{userId} {
  allow read: if request.auth.uid == userId;
  allow create, update: if request.auth.uid == userId;
  allow delete: if false;  // Prevent accidental deletion
}

// Rides: Public read, owner write
match /rides/{rideId} {
  allow read: if true;  // Anyone can browse rides
  allow create: if request.auth != null 
    && request.resource.data.userId == request.auth.uid;
  allow update, delete: if request.auth.uid == resource.data.userId;
}

// Bookings: Only parties involved can see
match /bookings/{bookingId} {
  allow read: if request.auth.uid == resource.data.userId 
    || request.auth.uid == resource.data.counterpartyId;
  allow create: if request.auth.uid == request.resource.data.userId;
  allow update: if request.auth.uid == resource.data.userId 
    || request.auth.uid == resource.data.counterpartyId;
}
```

### Important Limitations

‚ö†Ô∏è **Current rules do NOT include:**
- Rate limiting (can be abused)
- Advanced data validation
- Spam prevention
- IP-based blocking

**Recommendation for new owner:** Enhance these rules with:
- Rate limiting per user
- Stricter data validation
- Monitoring for abuse patterns

---

## 3. Firebase Cloud Functions | Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©

**File:** `functions/index.js`  
**Runtime:** Node.js 18+  
**Region:** us-central1 (default)

### Function List

#### 1. Scheduled Payment Capture (Planned)

**Purpose:** Auto-capture PayPal payments after 48 hours

```javascript
// Pseudo-code (not fully implemented yet)
exports.scheduledPaymentCapture = functions.pubsub
  .schedule('every 1 hours')
  .onRun(async (context) => {
    // 1. Find all authorized bookings older than 48h
    // 2. Capture payment via PayPal API
    // 3. Update booking status to "captured"
    // 4. Send confirmation email
  });
```

**Status:** ‚ö†Ô∏è Partially implemented, needs completion  
**Priority:** HIGH for new owner

#### 2. Email Notifications (Active)

**Purpose:** Send emails via EmailJS when bookings created

```javascript
// Already implemented in client-side
// Uses EmailJS service
// See src/pages/BookRide.jsx lines 144-169
```

---

## 4. External APIs | ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©

### 4.1 PayPal Payments API

**Base URL:** `https://api-m.paypal.com` (production)  
**Base URL:** `https://api-m.sandbox.paypal.com` (sandbox)

#### Used Endpoints

**1. Create Order (Authorize)**
```http
POST /v2/checkout/orders
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "intent": "AUTHORIZE",
  "purchase_units": [{
    "amount": {
      "currency_code": "SEK",
      "value": "10.00"
    }
  }]
}
```

**2. Authorize Payment**
```http
POST /v2/checkout/orders/{order_id}/authorize
Authorization: Bearer {access_token}
```

**3. Capture Authorization**
```http
POST /v2/payments/authorizations/{authorization_id}/capture
Authorization: Bearer {access_token}
```

**4. Void Authorization**
```http
POST /v2/payments/authorizations/{authorization_id}/void
Authorization: Bearer {access_token}
```

#### Implementation

**Component:** `src/components/PayPalSimple.jsx`  
**Page:** `src/pages/UnlockContactPage.jsx`  
**Config:** `src/config/env.js`

---

### 4.2 EmailJS API

**Base URL:** `https://api.emailjs.com/api/v1.0`

#### Used Endpoints

**Send Email**
```http
POST /email/send
Content-Type: application/json

{
  "service_id": "service_m8mzozz",
  "template_id": "template_x455par",
  "user_id": "mJIhMTymsdPK6yVzj",
  "template_params": {
    "to_name": "Johan",
    "to_email": "johan@example.com",
    "subject": "Ny bokningsf√∂rfr√•gan",
    "message_content": "..."
  }
}
```

#### Implementation

**Used in:** `src/pages/BookRide.jsx`  
**Package:** `@emailjs/browser`

---

### 4.3 Firebase Authentication API

**Google OAuth Sign-In**

```javascript
import { signInWithPopup, GoogleAuthProvider } from "firebase/auth";

const provider = new GoogleAuthProvider();
const result = await signInWithPopup(auth, provider);
const user = result.user;
```

**Phone Verification**

```javascript
import { RecaptchaVerifier, signInWithPhoneNumber } from "firebase/auth";

// 1. Setup reCAPTCHA
const recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {}, auth);

// 2. Send OTP
const confirmationResult = await signInWithPhoneNumber(
  auth, 
  phoneNumber, 
  recaptchaVerifier
);

// 3. Verify OTP
await confirmationResult.confirm(otpCode);
```

---

### 4.4 Firebase Cloud Messaging (FCM)

**Send Push Notification** (Server-side)

```http
POST https://fcm.googleapis.com/fcm/send
Authorization: key={SERVER_KEY}
Content-Type: application/json

{
  "to": "{device_token}",
  "notification": {
    "title": "Ny bokningsf√∂rfr√•gan",
    "body": "Du har f√•tt en ny f√∂rfr√•gan!"
  },
  "data": {
    "type": "booking_request",
    "rideId": "ride123"
  }
}
```

**Status:** ‚ö†Ô∏è Partially implemented  
**Missing:** Server-side FCM sending logic

---

## 5. Data Flow Diagrams | ŸÖÿÆÿ∑ÿ∑ÿßÿ™ ÿ™ÿØŸÅŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

### Flow 1: User Registration & Login

```
1. User clicks "Logga in"
   ‚Üì
2. Google OAuth popup
   ‚Üì
3. User authorizes
   ‚Üì
4. Firebase Auth creates user
   ‚Üì
5. App redirects to /verify-phone
   ‚Üì
6. User enters phone number
   ‚Üì
7. Firebase sends SMS with OTP
   ‚Üì
8. User enters OTP
   ‚Üì
9. Firebase verifies OTP
   ‚Üì
10. Phone number saved to user document
    ‚Üì
11. User redirected to /home
```

---

### Flow 2: Create Ride (Driver)

```
1. Driver clicks "Skapa resa"
   ‚Üì
2. Selects role: "F√∂rare" (driver)
   ‚Üì
3. Fills form:
   - Origin, Destination
   - Date, Time
   - Price, Seats
   - Car details
   ‚Üì
4. Clicks "Publicera erbjudande"
   ‚Üì
5. Firestore writes to "rides" collection
   ‚Üì
6. Ride appears in search results immediately
   ‚Üì
7. Driver redirected to /my-rides
```

---

### Flow 3: Book Ride (Passenger)

```
1. Passenger searches for rides
   ‚Üì
2. Finds suitable ride
   ‚Üì
3. Clicks "Boka"
   ‚Üì
4. Redirected to /book-ride/:rideId
   ‚Üì
5. Fills contact info:
   - Name (autofilled)
   - Phone (verified, required)
   - Email (optional)
   - Message to driver
   ‚Üì
6. Accepts terms
   ‚Üì
7. Clicks "Skicka bokningsf√∂rfr√•gan"
   ‚Üì
8. Firestore writes to "bookings" collection
   - status: "requested"
   - commission: 0
   ‚Üì
9. Email sent to driver (EmailJS)
   ‚Üì
10. Notification created for driver
    ‚Üì
11. Success page shown to passenger
    ‚Üì
12. Passenger redirected to /inbox?tab=bokningar
```

---

### Flow 4: Unlock Contact (Driver ‚Üí Passenger)

```
1. Driver sees booking in /inbox?tab=resor
   ‚Üì
2. Clicks "L√•s upp kontakt" (10 SEK)
   ‚Üì
3. Redirected to /unlock-contact/:bookingId
   ‚Üì
4. PayPal modal opens
   ‚Üì
5. Driver authorizes payment (10 SEK)
   ‚Üì
6. PayPal returns orderId + status: "AUTHORIZED"
   ‚Üì
7. Firestore transaction:
   - Update booking:
     * status: "authorized"
     * paidAt: now()
     * contactUnlockedAt: now()
     * commission: 10
     * paypal: { orderId, status: "AUTHORIZED", amount: 10 }
   - Create contact_unlock document
   ‚Üì
8. Contact info revealed to driver:
   - passengerName
   - passengerPhone
   - passengerEmail (if provided)
   ‚Üì
9. Driver can now call/text passenger directly
   ‚Üì
10. Driver redirected to success page
    ‚Üì
11. 48-hour window starts:
    - Driver can report issue ‚Üí Payment voided
    - No report ‚Üí Payment auto-captured
```

---

### Flow 5: Auto-Capture (After 48 Hours)

```
1. Firebase Cloud Function runs every hour
   ‚Üì
2. Queries bookings:
   - status: "authorized"
   - paidAt < (now - 48 hours)
   ‚Üì
3. For each booking:
   a. Call PayPal Capture API
   b. PayPal returns captureId
   c. Update booking:
      * status: "captured"
      * paypal.status: "CAPTURED"
      * paypal.captureId: captureId
   ‚Üì
4. Money transferred to platform account
   ‚Üì
5. Send confirmation email (optional)
```

**Status:** ‚ö†Ô∏è Not fully implemented  
**TODO:** Complete this function in `functions/index.js`

---

### Flow 6: Report & Refund (Within 48 Hours)

```
1. User clicks "Rapportera problem"
   ‚Üì
2. Fills report form
   ‚Üì
3. Submits report
   ‚Üì
4. Firestore writes to reports collection (planned)
   ‚Üì
5. Check if < 48 hours since unlock
   ‚Üì
6. If YES:
   a. Call PayPal Void API
   b. PayPal voids authorization
   c. Update booking:
      * status: "voided"
      * paypal.status: "VOIDED"
   d. Money returned to user's card
   ‚Üì
7. Send confirmation email
```

**Status:** ‚ö†Ô∏è Partially implemented  
**TODO:** Complete backend logic

---

## 6. Common Queries | ÿßŸÑÿßÿ≥ÿ™ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©

### Get Active Rides (Home Page)

```javascript
const ridesQuery = query(
  collection(db, "rides"),
  where("archived", "==", false),
  where("status", "==", "active"),
  orderBy("createdAt", "desc"),
  limit(50)
);

const snapshot = await getDocs(ridesQuery);
const rides = snapshot.docs.map(doc => ({
  id: doc.id,
  ...doc.data()
}));
```

---

### Search Rides by Route

```javascript
const searchQuery = query(
  collection(db, "rides"),
  where("origin", "==", "Stockholm, Sweden"),
  where("destination", "==", "G√∂teborg, Sweden"),
  where("archived", "==", false),
  where("status", "==", "active")
);
```

**‚ö†Ô∏è Note:** Requires composite index in `firestore.indexes.json`

---

### Get User's Bookings (as Passenger)

```javascript
const passengerBookingsQuery = query(
  collection(db, "bookings"),
  where("userId", "==", currentUserId),
  orderBy("createdAt", "desc")
);
```

---

### Get Driver's Incoming Requests

```javascript
const driverBookingsQuery = query(
  collection(db, "bookings"),
  where("counterpartyId", "==", currentUserId),
  orderBy("createdAt", "desc")
);
```

---

### Real-Time Listener (Inbox)

```javascript
const unsubscribe = onSnapshot(
  driverBookingsQuery,
  (snapshot) => {
    const bookings = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    setBookings(bookings);
  },
  (error) => {
    console.error("Listener error:", error);
  }
);

// Cleanup
return () => unsubscribe();
```

---

## 7. Indexes Required | ÿßŸÑŸÅŸáÿßÿ±ÿ≥ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©

**File:** `firestore.indexes.json`

### Current Indexes

```json
{
  "indexes": [
    {
      "collectionGroup": "rides",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "archived", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "rides",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "origin", "order": "ASCENDING" },
        { "fieldPath": "destination", "order": "ASCENDING" },
        { "fieldPath": "archived", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "bookings",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "counterpartyId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}
```

### Deploy Indexes

```bash
firebase deploy --only firestore:indexes
```

---

## üìö Additional Resources

### Firebase Documentation
- Firestore: https://firebase.google.com/docs/firestore
- Auth: https://firebase.google.com/docs/auth
- Functions: https://firebase.google.com/docs/functions

### PayPal Documentation
- Orders API: https://developer.paypal.com/docs/api/orders/v2
- Payments API: https://developer.paypal.com/docs/api/payments/v2

### EmailJS Documentation
- API: https://www.emailjs.com/docs/

---

**Document Version:** 1.0  
**Last Updated:** 2025-10-07  
**For Questions:** See HANDOVER_GUIDE.md